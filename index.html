<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ’° Quáº£n lÃ½ chi tiÃªu nhÃ³m</title>
  <link rel="stylesheet" href="style.css" />
  <style>
  </style>
</head>

<body>
  <header>
    <h1>ğŸ’° Quáº£n lÃ½ chi tiÃªu nhÃ³m</h1>
    <button id="reportBtn" class="btn">ğŸ“Š BÃ¡o cÃ¡o</button>
    <div class="header-buttons">
      <div class="icon-buttons">
        <button id="memberIcon" onclick="handleNotificationClick && handleNotificationClick()">
          <span id="notificationDot" class="notification-dot"></span> ğŸ””
        </button>
        <div id="notificationMessage" class="notification-message"></div>
      </div>
      <button onclick="toggleTheme()" id="themeBtn">ğŸŒ™ Dark Mode</button>
      <button onclick="openMemberModal()">ğŸ‘¥ ThÃ nh viÃªn</button>
      <button onclick="exportReport()">ğŸ“¤ Xuáº¥t Excel</button>
      <button onclick="logout()">ÄÄƒng xuáº¥t</button>
      <div id="monthlyReport" style="margin-top: 20px;"></div>

    </div>
  </header>

  <main>
    <div class="column" id="col1">
      <h2>Chi tiÃªu</h2>
      <button class="add-card" onclick="addCard(this)">+ ThÃªm chi tiÃªu</button>
    </div>

    <div class="column" id="col2">
      <h2 onclick="renameColumn(this)">ThÃ¡ng 10</h2>
      <button class="add-card" onclick="addCard(this)">+ ThÃªm ghi chÃº</button>
    </div>

    <div class="column" id="col3">
      <h2>Quyáº¿t toÃ¡n</h2>
      <div class="card">Tá»•ng chi: 0Ä‘</div>
      <div class="card">Chia Ä‘á»u: 0Ä‘/ngÆ°á»i</div>
      <button class="add-card" onclick="calculate()">ğŸ’¡ TÃ­nh tá»•ng</button>
    </div>

    <div class="column" id="col4">
      <h2>Chia tiá»n</h2>
      <div id="shareList"></div>
    </div>
  </main>

  <!-- Popup thÃ nh viÃªn -->
  <div id="memberModal" style="display:none">
    <div class="modal-content">
      <h3>Danh sÃ¡ch thÃ nh viÃªn</h3>
      <ul class="member-list" id="memberList"></ul>
      <input type="text" id="newMember" placeholder="TÃªn thÃ nh viÃªn..." />
      <button onclick="addMember()">ThÃªm</button>
      <br />
      <button onclick="closeMemberModal()">ÄÃ³ng</button>
    </div>
  </div>

  <script>
    // ======= ÄÄƒng xuáº¥t =======
    function logout() {
      alert("ÄÄƒng xuáº¥t thÃ nh cÃ´ng!");
      window.location.href = "login.html";
    }

    // ======= Äá»•i tÃªn báº£ng =======
    function renameColumn(title) {
      const newName = prompt("Nháº­p tÃªn má»›i cho báº£ng:", title.textContent);
      if (newName && newName.trim() !== "") title.textContent = newName.trim();
    }

    // ======= Hiá»ƒn thá»‹ chi tiÃªu tá»« DB =======
    async function loadExpenses() {
      const currentGroupId = localStorage.getItem("currentGroupId");
      if (!currentGroupId) return;

      try {
        const res = await fetch(`http://localhost:3000/get-expenses/${currentGroupId}`);
        const data = await res.json();
        if (!data.success) {
          console.warn("Lá»—i khi táº£i chi tiÃªu:", data.message);
          return;
        }

        const column = document.getElementById("col1");
        const addBtn = column.querySelector(".add-card");
        // remove only expense cards (keep static cards if any)
        column.querySelectorAll(".card[data-expense-id]").forEach((c) => c.remove());

        data.expenses.forEach((exp) => {
          const card = document.createElement("div");
          card.className = "card";
          card.draggable = true;
          card.dataset.expenseId = exp.expense_id;
          card.dataset.amount = exp.amount; // lÆ°u sá»‘ tiá»n chÃ­nh xÃ¡c

          const left = document.createElement("div");
          left.className = "left";

          const span = document.createElement("span");
          span.textContent = `${exp.title} - ${Number(exp.amount).toLocaleString()}Ä‘`;

          const tagDisplay = document.createElement("span");
          tagDisplay.className = "tag-display";
          // dÃ¹ng note tá»« DB (server Ä‘ang lÆ°u note)
          tagDisplay.textContent = exp.note || "ğŸ“¦ KhÃ¡c";

          left.appendChild(span);
          left.appendChild(tagDisplay);

          // controls: tag, edit, delete
          const ctr = document.createElement("div");
          ctr.className = "controls";

          const tagBtn = document.createElement("button");
          tagBtn.className = "tag-btn";
          tagBtn.title = "Thay Ä‘á»•i nhÃ£n";
          tagBtn.innerText = "ğŸ·ï¸";
          tagBtn.onclick = (e) => { e.stopPropagation(); showTagMenu(card); };

          const editBtn = document.createElement("button");
          editBtn.className = "edit-btn";
          editBtn.title = "Sá»­a";
          editBtn.innerText = "âœï¸";
          editBtn.onclick = (e) => { e.stopPropagation(); editExpense(card); };

          const delBtn = document.createElement("button");
          delBtn.className = "del-btn";
          delBtn.title = "XÃ³a";
          delBtn.innerText = "ğŸ—‘ï¸";
          delBtn.onclick = (e) => { e.stopPropagation(); deleteExpense(card); };

          ctr.appendChild(tagBtn);
          ctr.appendChild(editBtn);
          ctr.appendChild(delBtn);

          card.appendChild(left);
          card.appendChild(ctr);

          addDragEvents(card);
          column.insertBefore(card, addBtn);
        });
      } catch (err) {
        console.error("Lá»—i khi loadExpenses:", err);
      }
    }

    // ======= ThÃªm chi tiÃªu má»›i =======
    async function addCard(btn) {
      const column = btn.parentElement;
      const text = prompt("Nháº­p ná»™i dung chi tiÃªu (VD: Mua Ä‘á»“ Äƒn):");
      if (!text || !text.trim()) return;

      const amountInput = prompt("Nháº­p sá»‘ tiá»n (chá»‰ nháº­p sá»‘):");
      const amount = parseFloat(amountInput);
      if (isNaN(amount) || amount <= 0) return alert("Sá»‘ tiá»n khÃ´ng há»£p lá»‡!");

      const currentGroupId = localStorage.getItem("currentGroupId");
      const currentUser = JSON.parse(localStorage.getItem("loggedInUser") || "null");
      const currentUserId = currentUser?.user_id || currentUser?.userId || currentUser?.id;
      if (!currentGroupId || !currentUserId) return alert("ChÆ°a chá»n nhÃ³m hoáº·c chÆ°a Ä‘Äƒng nháº­p!");

      try {
        const res = await fetch("http://localhost:3000/add-expense", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: text,
            amount,
            category: "ğŸ“¦ KhÃ¡c", // server sáº½ map vÃ o note
            groupId: Number(currentGroupId),
            createdBy: Number(currentUserId),
          }),
        });

        const data = await res.json();
        if (data.success) {
          alert("âœ… ÄÃ£ thÃªm chi tiÃªu!");
          await loadExpenses();
        } else {
          alert("âš ï¸ " + (data.message || "Lá»—i khi thÃªm"));
        }
      } catch (err) {
        console.error("Lá»—i khi thÃªm chi tiÃªu:", err);
        alert("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i server!");
      }
    }

    // ======= Menu chá»n tag (cáº­p nháº­t DB) =======
    function showTagMenu(card) {
      const tags = [
        { label: "ğŸœ Ä‚n uá»‘ng" },
        { label: "ğŸš— Äi láº¡i" },
        { label: "ğŸ›ï¸ Mua sáº¯m" },
        { label: "ğŸ® Giáº£i trÃ­" },
        { label: "ğŸ“¦ KhÃ¡c" },
      ];

      const oldMenu = document.querySelector(".tag-menu");
      if (oldMenu) oldMenu.remove();

      const menu = document.createElement("div");
      menu.className = "tag-menu";

      tags.forEach((tag) => {
        const item = document.createElement("div");
        item.textContent = tag.label;

        item.onclick = async () => {
          const tagDisplay = card.querySelector(".tag-display");
          tagDisplay.textContent = tag.label;
          menu.remove();

          // === Gá»­i cáº­p nháº­t tag lÃªn server ===
          const expenseId = card.dataset.expenseId;
          if (!expenseId) {
            console.error("Thiáº¿u expenseId trong card khi cáº­p nháº­t tag");
            return;
          }

          try {
            const res = await fetch("http://localhost:3000/update-expense-tag", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                expenseId: Number(expenseId),
                newTag: tag.label,
              }),
            });

            const result = await res.json();
            if (!result.success) {
              alert("Lá»—i khi cáº­p nháº­t tag: " + (result.message || ""));
            } else {
              // náº¿u cáº§n reload toÃ n bá»™ list, uncomment dÃ²ng sau:
              // await loadExpenses();
            }
          } catch (err) {
            console.error("Lá»—i khi cáº­p nháº­t tag:", err);
            alert("KhÃ´ng thá»ƒ káº¿t ná»‘i server!");
          }
        };

        menu.appendChild(item);
      });

      document.body.appendChild(menu);
      const rect = card.getBoundingClientRect();
      menu.style.left = rect.right + "px";
      menu.style.top = rect.top + "px";

      document.addEventListener("click", () => menu.remove(), { once: true });
    }

    // ======= KÃ©o tháº£ =======
    function addDragEvents(card) {
      card.addEventListener("dragstart", () => card.classList.add("dragging"));
      card.addEventListener("dragend", () => card.classList.remove("dragging"));
    }

    document.querySelectorAll(".column").forEach((col) => {
      col.addEventListener("dragover", (e) => {
        e.preventDefault();
        const dragging = document.querySelector(".dragging");
        const addBtn = col.querySelector(".add-card");
        if (dragging && addBtn) col.insertBefore(dragging, addBtn);
      });
    });

    // ======= ThÃ nh viÃªn (simple local + server) =======
    const memberModal = document.getElementById("memberModal");
    const memberList = document.getElementById("memberList");
    const newMemberInput = document.getElementById("newMember");

    function openMemberModal() {
      memberModal.style.display = "block";
      loadMembers();
    }
    function closeMemberModal() {
      memberModal.style.display = "none";
    }

    function loadMembers() {
      const currentGroupId = localStorage.getItem("currentGroupId");
      // Try server first, fallback to localStorage
      if (!currentGroupId) {
        memberList.innerHTML = "<li>ChÆ°a chá»n nhÃ³m</li>";
        return;
      }

      fetch(`http://localhost:3000/get-members/${currentGroupId}`)
        .then(r => r.json())
        .then(data => {
          if (data?.success) {
            memberList.innerHTML = data.members.map((m, i) =>
              `<li>ğŸ‘¤ ${m.username || m.name || m.user_id} <button class="delete-btn" onclick="removeMember(${i})">âŒ</button></li>`
            ).join("");
          } else {
            // fallback: localStorage members
            const members = JSON.parse(localStorage.getItem("members") || "[]");
            memberList.innerHTML = members.map((m, i) => `<li>ğŸ‘¤ ${m} <button class="delete-btn" onclick="removeMember(${i})">âŒ</button></li>`).join("");
          }
        })
        .catch(_ => {
          const members = JSON.parse(localStorage.getItem("members") || "[]");
          memberList.innerHTML = members.map((m, i) => `<li>ğŸ‘¤ ${m} <button class="delete-btn" onclick="removeMember(${i})">âŒ</button></li>`).join("");
        });
    }

    async function addMember() {
      const name = newMemberInput.value.trim();
      if (!name) return alert("Nháº­p tÃªn thÃ nh viÃªn!");
      const currentGroupId = localStorage.getItem("currentGroupId");
      if (!currentGroupId) return alert("ChÆ°a chá»n nhÃ³m!");

      try {
        const res = await fetch("http://localhost:3000/add-member", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ groupId: Number(currentGroupId), username: name }),
        });
        const data = await res.json();
        if (data.success) {
          alert("âœ… " + data.message);
          newMemberInput.value = "";
          loadMembers();
        } else {
          alert("âš ï¸ " + (data.message || ""));
        }
      } catch (err) {
        console.error("Lá»—i khi thÃªm thÃ nh viÃªn:", err);
        alert("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i server!");
      }
    }

    function removeMember(index) {
      // local fallback delete (server-side removal not implemented here)
      let members = JSON.parse(localStorage.getItem("members") || "[]");
      members.splice(index, 1);
      localStorage.setItem("members", JSON.stringify(members));
      loadMembers();
    }

    // ======= TÃ­nh toÃ¡n: tÃ­nh Ä‘Ãºng vÃ  chia Ä‘á»u cho tá»«ng user trong nhÃ³m =======
    async function calculate() {
      const currentGroupId = localStorage.getItem("currentGroupId");
      if (!currentGroupId) return alert("ChÆ°a chá»n nhÃ³m!");

      try {
        // Láº¥y chi tiÃªu tá»« server
        const expRes = await fetch(`http://localhost:3000/get-expenses/${currentGroupId}`);
        const expData = await expRes.json();
        if (!expData.success) throw new Error("KhÃ´ng láº¥y Ä‘Æ°á»£c expenses");

        // Láº¥y members tá»« server (náº¿u server chÆ°a cÃ³ route, fallback to localStorage)
        let members = [];
        try {
          const memRes = await fetch(`http://localhost:3000/get-members/${currentGroupId}`);
          const memData = await memRes.json();
          if (memData.success) members = memData.members;
        } catch (_) {
          // fallback
          const memLocal = JSON.parse(localStorage.getItem("members") || "[]");
          // memLocal may be array of names or objects
          members = memLocal.map(m => (typeof m === "string" ? { username: m } : m));
        }

        if (!members || members.length === 0) return alert("NhÃ³m chÆ°a cÃ³ thÃ nh viÃªn!");

        // TÃ­nh tá»•ng chÃ­nh xÃ¡c (dÃ¹ng sá»‘ thá»±c)
        let total = 0;
        expData.expenses.forEach(e => {
          total += Number(e.amount) || 0;
        });

        const perPerson = total / members.length;

        // Cáº­p nháº­t giao diá»‡n chÃ­nh xÃ¡c
        const col3Cards = document.querySelectorAll("#col3 .card");
        if (col3Cards.length >= 2) {
          col3Cards[0].textContent = `Tá»•ng chi: ${total.toLocaleString()}Ä‘`;
          col3Cards[1].textContent = `Chia Ä‘á»u: ${perPerson.toLocaleString()}Ä‘/ngÆ°á»i`;
        } else {
          console.warn("KhÃ´ng tÃ¬m tháº¥y tháº» card trong cá»™t Quyáº¿t toÃ¡n!");
        }

        const shareList = document.getElementById("shareList");
        shareList.innerHTML = members.map(m => {
          const name = m.username || m.name || m;
          return `<div class="card">${name}: ${perPerson.toLocaleString()}Ä‘</div>`;
        }).join("");
      } catch (err) {
        console.error("Lá»—i khi tÃ­nh toÃ¡n:", err);
        alert("âŒ KhÃ´ng thá»ƒ tÃ­nh toÃ¡n: " + (err.message || ""));
      }
    }

    // ======= Sá»­a chi tiÃªu =======
    async function editExpense(card) {
      const expenseId = card.dataset.expenseId;
      if (!expenseId) return alert("KhÃ´ng cÃ³ expenseId!");

      const span = card.querySelector(".left span");
      const oldText = span?.textContent || "";
      const oldTitle = oldText.split(" - ")[0] || "";
      const oldAmountStr = (oldText.split(" - ")[1] || "0Ä‘").replace("Ä‘", "").replace(/,/g, "");
      const newTitle = prompt("Nháº­p tÃªn chi tiÃªu má»›i:", oldTitle);
      if (!newTitle) return;
      const newAmountInput = prompt("Nháº­p sá»‘ tiá»n má»›i:", oldAmountStr);
      const newAmount = parseFloat(newAmountInput);
      if (isNaN(newAmount)) return alert("Sá»‘ tiá»n khÃ´ng há»£p lá»‡!");

      try {
        const res = await fetch("http://localhost:3000/update-expense", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            expenseId: Number(expenseId),
            title: newTitle.trim(),
            amount: newAmount,
          }),
        });
        const data = await res.json();
        if (data.success) {
          alert("âœ… ÄÃ£ cáº­p nháº­t chi tiÃªu!");
          await loadExpenses();
        } else {
          alert("âš ï¸ " + (data.message || ""));
        }
      } catch (err) {
        console.error("Lá»—i editExpense:", err);
        alert("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i server!");
      }
    }

    // ======= XÃ³a chi tiÃªu =======
    async function deleteExpense(card) {
      const expenseId = card.dataset.expenseId;
      if (!expenseId) return alert("KhÃ´ng cÃ³ expenseId!");
      if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a chi tiÃªu nÃ y khÃ´ng?")) return;

      try {
        const res = await fetch("http://localhost:3000/delete-expense", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ expenseId: Number(expenseId) }),
        });
        const data = await res.json();
        if (data.success) {
          alert("ğŸ—‘ï¸ ÄÃ£ xÃ³a chi tiÃªu!");
          card.remove();
        } else {
          alert("âš ï¸ " + (data.message || ""));
        }
      } catch (err) {
        console.error("Lá»—i deleteExpense:", err);
        alert("âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i server!");
      }
    }

    // ======= Giao diá»‡n sÃ¡ng / tá»‘i =======
    const themeBtn = document.getElementById("themeBtn");
    const currentTheme = localStorage.getItem("theme") || "dark";
    document.body.classList.toggle("light", currentTheme === "light");
    updateThemeButton();

    function toggleTheme() {
      document.body.classList.toggle("light");
      const isLight = document.body.classList.contains("light");
      localStorage.setItem("theme", isLight ? "light" : "dark");
      updateThemeButton();
    }

    function updateThemeButton() {
      const isLight = document.body.classList.contains("light");
      themeBtn.textContent = isLight ? "â˜€ï¸ Light Mode" : "ğŸŒ™ Dark Mode";
    }

    // ======= Load khi má»Ÿ trang =======
    window.addEventListener("load", loadExpenses);


    // =================== BÃO CÃO CHI TIÃŠU THEO THÃNG ===================
    async function loadMonthlyReport() {
      const reportDiv = document.getElementById("monthlyReport");
      if (!reportDiv) return console.error("âŒ KhÃ´ng tÃ¬m tháº¥y #monthlyReport");

      const groupId = localStorage.getItem("currentGroupId");
      if (!groupId) {
        reportDiv.style.display = "block";
        reportDiv.innerHTML = "<div>âš ï¸ Báº¡n chÆ°a chá»n nhÃ³m â€” vÃ o Home vÃ  nháº¥n 'Xem' nhÃ³m trÆ°á»›c.</div>";
        return;
      }

      reportDiv.style.display = "block";
      reportDiv.innerHTML = "<em>â³ Äang táº£i bÃ¡o cÃ¡o...</em>";

      try {
        const res = await fetch(`http://localhost:3000/report/monthly/${groupId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.success || !data.report?.length) {
          reportDiv.innerHTML = "<div>KhÃ´ng cÃ³ dá»¯ liá»‡u bÃ¡o cÃ¡o.</div>";
          return;
        }

        // Giao diá»‡n dropdown chá»n thÃ¡ng
        reportDiv.innerHTML = `
      <h3 style="margin:0 0 6px 0">ğŸ“Š BÃ¡o cÃ¡o chi tiÃªu theo thÃ¡ng</h3>
      <label>Chá»n thÃ¡ng:
        <select id="monthFilter">
          <option value="all">Táº¥t cáº£</option>
          ${data.report.map(r => `<option value="${r.month}">${r.month}</option>`).join("")}
        </select>
      </label>
      <div id="reportTable" style="margin-top:8px;"></div>
    `;

        const reportTable = document.getElementById("reportTable");

        function renderTable(filterMonth) {
          const filtered = (filterMonth === "all")
            ? data.report
            : data.report.filter(r => r.month === filterMonth);

          if (!filtered.length) {
            reportTable.innerHTML = "<div>KhÃ´ng cÃ³ dá»¯ liá»‡u cho thÃ¡ng nÃ y.</div>";
            return;
          }

          reportTable.innerHTML = `
        <table style="border-collapse:collapse;width:100%">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px">ThÃ¡ng</th>
              <th style="text-align:right;padding:6px">Tá»•ng (â‚«)</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(r => `
              <tr>
                <td style="padding:6px">${r.month}</td>
                <td style="padding:6px;text-align:right">${Number(r.total).toLocaleString("vi-VN")}Ä‘</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
        }

        // render máº·c Ä‘á»‹nh
        renderTable("all");

        // láº¯ng nghe sá»± kiá»‡n chá»n thÃ¡ng
        document.getElementById("monthFilter").addEventListener("change", (e) => {
          renderTable(e.target.value);
        });
      } catch (err) {
        console.error("Lá»—i loadMonthlyReport:", err);
        reportDiv.innerHTML = "<div>âŒ Lá»—i khi táº£i bÃ¡o cÃ¡o. Xem console Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.</div>";
      }
    }

    // ======= NÃºt báº­t/táº¯t bÃ¡o cÃ¡o =======
    const reportBtn = document.getElementById("reportBtn");
    if (reportBtn) {
      reportBtn.addEventListener("click", () => {
        const reportDiv = document.getElementById("monthlyReport");
        if (!reportDiv) return;

        if (!reportDiv.style.display || reportDiv.style.display === "none") {
          loadMonthlyReport();
        } else {
          reportDiv.style.display = "none";
          reportDiv.innerHTML = "";
        }
      });
    }

    // áº¨n máº·c Ä‘á»‹nh khi má»›i vÃ o
    const reportContainer = document.getElementById("monthlyReport");
    if (reportContainer) reportContainer.style.display = "none";

    async function exportReport() {
      const groupId = localStorage.getItem("currentGroupId");
      if (!groupId) return alert("âš ï¸ ChÆ°a chá»n nhÃ³m!");

      window.open(`http://localhost:3000/report/export/${groupId}`, "_blank");
    }
  </script>

</body>

</html>